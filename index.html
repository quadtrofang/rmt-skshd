<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem RMT SKSHD - Cloud v5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        @media print { 
            html, body { height: auto !important; overflow: visible !important; background: white !important; }
            .h-screen { height: auto !important; }
            .overflow-hidden, .overflow-y-auto { overflow: visible !important; height: auto !important; }
            #print-overlay { position: static !important; padding: 0 !important; height: auto !important; display: block !important; }
            
            .no-print { display: none !important; } 
            .print-area { display: block !important; padding: 0 !important; margin: 0 !important; width: 100% !important; max-width: none !important;}
            table { border-collapse: collapse !important; width: 100% !important; margin-bottom: 20px; }
            th, td { border: 1px solid black !important; padding: 4px !important; color: black !important; font-size: 9px !important; text-transform: uppercase; }
            th { background-color: #f3f4f6 !important; font-weight: bold; text-align: center; }
            .print-header { border-bottom: 2px solid black; margin-bottom: 20px; padding-bottom: 10px; text-align: center; font-weight: bold;}
            .signature-space { margin-top: 40px; display: flex; justify-content: space-between; }
            .sig-box { width: 200px; text-align: center; padding-top: 5px; font-weight: bold; font-size: 10px; }
            
            /* Print Orientation */
            @page { margin: 1cm; size: landscape; }
            body.portrait-mode @page { size: portrait; margin: 1.5cm; }
            .page-break { page-break-after: always; }
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .nav-active { background-color: #059669; color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2); }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-800 text-xs h-screen flex flex-col overflow-hidden">

    <!-- OVERLAY LOADING -->
    <div id="loader" class="fixed inset-0 bg-slate-900 z-[9999] flex flex-col items-center justify-center text-white p-6 transition-all duration-500">
        <div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="loader-text" class="font-bold text-[9px] uppercase tracking-[0.3em] text-emerald-400">Menyambung Pangkalan Data...</p>
        <div id="diag-box" class="hidden mt-6 p-4 bg-rose-500/10 border border-rose-500/30 rounded-2xl max-w-sm w-full text-center">
            <p id="diag-msg" class="text-rose-300 text-[10px] font-medium"></p>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <!-- SIDEBAR -->
        <aside class="hidden md:flex flex-col w-64 bg-slate-900 text-white no-print">
            <div class="p-6 bg-slate-950 border-b border-slate-800 flex items-center gap-3">
                <div class="p-2 bg-emerald-500 rounded-xl shadow-lg"><i data-lucide="cloud" class="w-5 h-5"></i></div>
                <div>
                    <h1 class="font-black text-xs uppercase tracking-tighter leading-none">Sistem RMT</h1>
                    <p class="text-[7px] font-bold text-emerald-400 uppercase mt-1 tracking-widest">SK Sg Haji Dorani</p>
                </div>
            </div>
            <nav class="flex-1 p-4 space-y-1">
                <button onclick="window.setTab('dash')" id="nav-dash" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all font-bold uppercase tracking-widest text-[9px] text-slate-400 hover:bg-slate-800">
                    <i data-lucide="check-square" class="w-4 h-4"></i> <span>Kehadiran (C9)</span>
                </button>
                <button onclick="window.setTab('stu')" id="nav-stu" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all font-bold uppercase tracking-widest text-[9px] text-slate-400 hover:bg-slate-800">
                    <i data-lucide="users" class="w-4 h-4"></i> <span>Borang Murid (C1-C4)</span>
                </button>
                <button onclick="window.setTab('rep')" id="nav-rep" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all font-bold uppercase tracking-widest text-[9px] text-slate-400 hover:bg-slate-800">
                    <i data-lucide="clipboard-list" class="w-4 h-4"></i> <span>Laporan Harian (C8)</span>
                </button>
                <button onclick="window.setTab('mon')" id="nav-mon" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all font-bold uppercase tracking-widest text-[9px] text-slate-400 hover:bg-slate-800">
                    <i data-lucide="shield-check" class="w-4 h-4"></i> <span>Pemantauan (C7)</span>
                </button>
            </nav>
        </aside>

        <!-- CONTENT AREA -->
        <div class="flex-1 flex flex-col overflow-hidden relative">
            <header class="md:hidden bg-slate-900 text-white p-3 flex justify-between items-center no-print shadow-xl">
                <div class="flex items-center gap-2">
                    <i data-lucide="cloud" class="w-4 h-4 text-emerald-400"></i>
                    <span class="font-black uppercase text-[10px]">RMT SKSHD</span>
                </div>
                <div class="flex gap-1">
                    <button onclick="window.setTab('dash')" class="p-2"><i data-lucide="check-square" class="w-4 h-4"></i></button>
                    <button onclick="window.setTab('stu')" class="p-2"><i data-lucide="users" class="w-4 h-4"></i></button>
                    <button onclick="window.setTab('rep')" class="p-2"><i data-lucide="clipboard-list" class="w-4 h-4"></i></button>
                    <button onclick="window.setTab('mon')" class="p-2"><i data-lucide="shield-check" class="w-4 h-4"></i></button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-4 md:p-8 custom-scroll bg-slate-50 no-print">
                <div id="content" class="max-w-6xl mx-auto"></div>
            </main>

            <!-- PRINT OVERLAY -->
            <div id="print-overlay" class="fixed inset-0 bg-white z-[5000] hidden overflow-y-auto p-4 md:p-10 text-black">
                <div class="no-print mb-8 flex justify-between items-center sticky top-0 bg-white/95 backdrop-blur-md p-4 border-b">
                    <h3 class="font-black uppercase text-xs">Cetak Borang RMT KPM</h3>
                    <div class="flex gap-2">
                        <button onclick="window.print()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold text-[9px] uppercase shadow-lg active:scale-95">Cetak / Simpan PDF</button>
                        <button onclick="document.getElementById('print-overlay').classList.add('hidden')" class="bg-slate-100 text-slate-500 px-6 py-2 rounded-lg font-bold text-[9px] uppercase">Tutup</button>
                    </div>
                </div>
                <!-- Tempat penjanaan borang (Boleh Portrait / Landscape) -->
                <div id="print-area" class="w-full bg-white print-area"></div>
            </div>
        </div>
    </div>

    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCdIiY2Bpu924jrZzaqVO0SqXvOYfPAjQc",
            authDomain: "rmt-skshd.firebaseapp.com",
            projectId: "rmt-skshd",
            storageBucket: "rmt-skshd.firebasestorage.app",
            messagingSenderId: "10103675688",
            appId: "1:10103675688:web:ddfec86ee46f4b2a148e1d",
            measurementId: "G-NQT5PZ1NDW"
        };

        const showError = (m) => {
            document.getElementById('diag-box').classList.remove('hidden');
            document.getElementById('diag-msg').innerText = m;
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "skshd-rmt-cloud-v5";

        let state = {
            tab: 'dash',
            students: [],
            attendance: {},
            reportsC8: [],
            reportsC7: [],
            selectedDate: new Date().toISOString().split('T')[0],
            printMonth: new Date().toISOString().substring(0, 7),
            searchQuery: '',
            filterClass: '',
            filterGender: '',
            editStudentId: null
        };

        window.setTab = (t) => { state.tab = t; render(); };
        window.changeDate = (d) => { state.selectedDate = d; render(); };
        window.updateSearch = (v) => { state.searchQuery = v; render(); };
        window.updateFilterClass = (v) => { state.filterClass = v; render(); };
        window.updateFilterGender = (v) => { state.filterGender = v; render(); };
        window.updatePrintMonth = (v) => { state.printMonth = v; render(); };

        function render() {
            const container = document.getElementById('content');
            document.querySelectorAll('aside nav button').forEach(b => b.classList.remove('nav-active'));
            const activeNav = document.getElementById(`nav-${state.tab}`);
            if (activeNav) activeNav.classList.add('nav-active');

            if (state.tab === 'dash') container.innerHTML = renderDashboard();
            else if (state.tab === 'stu') container.innerHTML = renderStudents();
            else if (state.tab === 'rep') container.innerHTML = renderReportsC8();
            else if (state.tab === 'mon') container.innerHTML = renderMonitoringC7();

            lucide.createIcons();
        }

        // ==========================================
        // UI: C9 KEHADIRAN
        // ==========================================
        function renderDashboard() {
            const date = state.selectedDate;
            const att = state.attendance[date] || {};
            // Secara lalai (default), semua murid dianggap hadir melainkan ditanda 'false'
            const hadir = state.students.length - Object.values(att).filter(v => v === false).length;

            const isConfirmed = !!state.attendance[date];

            // Jana senarai kelas yang unik untuk pilihan dropdown
            const uniqueClasses = [...new Set(state.students.map(s => s.className))].filter(Boolean).sort();
            
            // Logik tapisan (Filter) Murid
            const filteredStudents = state.students.filter(s => {
                const matchName = s.name.toLowerCase().includes((state.searchQuery || '').toLowerCase());
                const matchClass = state.filterClass ? s.className === state.filterClass : true;
                const matchGender = state.filterGender ? s.gender === state.filterGender : true;
                return matchName && matchClass && matchGender;
            });

            return `
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                    <div>
                        <h2 class="text-xl font-black uppercase tracking-tight">Kehadiran Harian (C9)</h2>
                        <div class="flex items-center gap-2 mt-2">
                            <input type="date" onchange="window.changeDate(this.value)" value="${date}" class="bg-white border border-slate-200 p-2 rounded-xl text-[10px] font-bold uppercase outline-none shadow-sm">
                            <button onclick="window.confirmAttendance()" class="${isConfirmed ? 'bg-emerald-600' : 'bg-blue-600'} text-white px-4 py-2 rounded-xl font-bold text-[9px] uppercase shadow-sm flex items-center gap-1 active:scale-95 transition-all">
                                <i data-lucide="check-circle" class="w-3.5 h-3.5"></i> ${isConfirmed ? 'Telah Disahkan' : 'Sahkan Hari Ini'}
                            </button>
                            ${isConfirmed ? `
                            <button onclick="window.resetAttendance()" class="bg-rose-500 hover:bg-rose-600 text-white px-4 py-2 rounded-xl font-bold text-[9px] uppercase shadow-sm flex items-center gap-1 active:scale-95 transition-all">
                                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Padam (Reset)
                            </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="flex gap-2">
                         <input type="month" onchange="window.updatePrintMonth(this.value)" value="${state.printMonth}" class="bg-white border p-2 rounded-xl text-[9px] font-bold uppercase outline-none">
                         <button onclick="window.preparePrint('C9_MONTH')" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl font-bold text-[9px] uppercase shadow-lg flex items-center gap-2">
                             <i data-lucide="printer" class="w-4 h-4"></i> Cetak C9 Bulanan
                         </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Jumlah Murid</p>
                        <p class="text-3xl font-black">${state.students.length}</p>
                    </div>
                    <div class="bg-emerald-50 p-6 rounded-3xl border border-emerald-100 shadow-sm text-emerald-700">
                        <p class="text-[9px] font-black uppercase tracking-widest mb-1">Hadir (Makan)</p>
                        <p class="text-3xl font-black">${hadir}</p>
                    </div>
                </div>

                <!-- BAR TAPISAN PENCARIAN -->
                <div class="flex flex-col md:flex-row gap-3 mb-6 p-4 bg-white rounded-3xl border border-slate-200 shadow-sm no-print">
                    <div class="flex-1 relative">
                        <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none text-slate-400">
                            <i data-lucide="search" class="w-4 h-4"></i>
                        </div>
                        <input type="text" placeholder="Cari nama murid..." oninput="window.updateSearch(this.value)" value="${state.searchQuery}" class="w-full pl-10 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-xs outline-none focus:border-emerald-500 uppercase transition-all">
                    </div>
                    <div class="w-full md:w-48">
                        <select onchange="window.updateFilterClass(this.value)" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-xs outline-none focus:border-emerald-500 uppercase transition-all">
                            <option value="">Semua Kelas</option>
                            ${uniqueClasses.map(c => `<option value="${c}" ${state.filterClass === c ? 'selected' : ''}>${c}</option>`).join('')}
                        </select>
                    </div>
                    <div class="w-full md:w-40">
                        <select onchange="window.updateFilterGender(this.value)" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-xs outline-none focus:border-emerald-500 uppercase transition-all">
                            <option value="">Semua Jantina</option>
                            <option value="L" ${state.filterGender === 'L' ? 'selected' : ''}>LELAKI (L)</option>
                            <option value="P" ${state.filterGender === 'P' ? 'selected' : ''}>PEREMPUAN (P)</option>
                        </select>
                    </div>
                </div>

                <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-slate-50 border-b border-slate-100 text-[9px] font-bold uppercase text-slate-400">
                            <tr><th class="p-5 w-16 text-center">BIL</th><th class="p-5">NAMA MURID & KELAS</th><th class="p-5 text-center">TANDAKAN STATUS</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            ${filteredStudents.length > 0 ? filteredStudents.map((s, i) => `
                                <tr class="hover:bg-slate-50 transition-colors">
                                    <td class="p-5 text-center font-bold text-slate-400">${i+1}</td>
                                    <td class="p-5 uppercase font-bold text-slate-700">
                                        ${s.name} <br><span class="text-[9px] font-black text-slate-400">${s.className} | ${s.gender || 'TIADA'}</span>
                                    </td>
                                    <td class="p-5 text-center">
                                        <button onclick="window.toggleAtt('${s.id}')" class="px-8 py-2.5 rounded-xl font-black text-[10px] uppercase transition-all shadow-sm active:scale-95 ${att[s.id] !== false ? 'bg-emerald-500 text-white border-b-4 border-emerald-700' : 'bg-rose-500 text-white border-b-4 border-rose-700'}">
                                            ${att[s.id] !== false ? 'HADIR' : 'TIDAK HADIR'}
                                        </button>
                                    </td>
                                </tr>
                            `).join('') : `<tr><td colspan="3" class="p-8 text-center font-bold text-slate-400 uppercase tracking-widest">Tiada murid dijumpai.</td></tr>`}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ==========================================
        // UI: C1-C4 URUS MURID
        // ==========================================
        function renderStudents() {
            return `
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-xl font-black uppercase tracking-tight">Pengurusan Borang (C1-C4)</h2>
                        <p class="text-[9px] font-bold text-slate-400 uppercase mt-1">Sistem Penjanaan Berpusat</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.preparePrint('C1')" class="bg-slate-800 text-white px-4 py-2 rounded-xl font-bold text-[9px] uppercase shadow-md">Cetak C1</button>
                        <button onclick="window.preparePrint('C2')" class="bg-slate-800 text-white px-4 py-2 rounded-xl font-bold text-[9px] uppercase shadow-md">Cetak C2</button>
                        <button onclick="window.preparePrint('C3')" class="bg-slate-800 text-white px-4 py-2 rounded-xl font-bold text-[9px] uppercase shadow-md">Cetak C3</button>
                        <button onclick="window.preparePrint('C4')" class="bg-emerald-600 text-white px-4 py-2 rounded-xl font-bold text-[9px] uppercase shadow-md flex items-center gap-1"><i data-lucide="printer" class="w-3 h-3"></i> Cetak C4</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-4 space-y-6">
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest">Daftar Murid Baru</h3>
                            <div class="space-y-4">
                                <input id="stuName" type="text" placeholder="NAMA PENUH" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl uppercase font-bold text-xs outline-none focus:border-emerald-500">
                                <div class="grid grid-cols-2 gap-2">
                                    <input id="stuClass" type="text" placeholder="TAHUN/KELAS" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl uppercase font-bold text-xs outline-none focus:border-emerald-500">
                                    <select id="stuGender" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl uppercase font-bold text-xs outline-none focus:border-emerald-500">
                                        <option value="L">LELAKI (L)</option><option value="P">PEREMPUAN (P)</option>
                                    </select>
                                </div>
                                
                                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                                    <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-3 border-b border-slate-200 pb-2">Maklumat Fizikal (Borang C1)</p>
                                    <div class="grid grid-cols-2 gap-2 mb-2">
                                        <input id="stuTinggiJan" type="number" step="0.01" placeholder="TINGGI JAN (M)" class="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold text-xs outline-none focus:border-emerald-500">
                                        <input id="stuBeratJan" type="number" step="0.1" placeholder="BERAT JAN (KG)" class="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold text-xs outline-none focus:border-emerald-500">
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input id="stuTinggiNov" type="number" step="0.01" placeholder="TINGGI NOV (M)" class="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold text-xs outline-none focus:border-emerald-500">
                                        <input id="stuBeratNov" type="number" step="0.1" placeholder="BERAT NOV (KG)" class="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold text-xs outline-none focus:border-emerald-500">
                                    </div>
                                </div>

                                <div class="flex gap-2">
                                    <button id="btnSubmitStudent" onclick="window.addStudent()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold uppercase text-[10px] shadow-lg transition-all">Simpan ke Pangkalan Data</button>
                                    <button id="btnCancelEdit" onclick="window.cancelEdit()" class="hidden bg-slate-200 text-slate-700 px-6 py-4 rounded-2xl font-bold uppercase text-[10px] shadow-sm transition-all hover:bg-slate-300">Batal</button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <h3 class="font-black uppercase text-[10px] text-slate-400 mb-4 tracking-widest">Daftar Pukal (Copy & Paste)</h3>
                            <p class="text-[8px] text-slate-500 font-bold uppercase mb-2">Format baris: NAMA, KELAS, JANTINA (L/P)</p>
                            <textarea id="bulkData" placeholder="ALI BIN ABU, 1 AMANAH, L" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl uppercase font-bold text-[10px] h-24 outline-none"></textarea>
                            <button onclick="window.addBulk()" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold uppercase text-[10px] mt-3 shadow-md">Upload Data Pukal</button>
                        </div>
                    </div>

                    <div class="lg:col-span-8 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                        <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest">Senarai Murid RMT (${state.students.length})</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 pb-4">
                            ${state.students.map(s => `
                                <div class="p-4 bg-slate-50 rounded-2xl flex justify-between items-center group transition-all hover:bg-white hover:shadow-md border border-slate-100">
                                    <div class="uppercase">
                                        <div class="font-bold text-slate-800 text-xs">${s.name}</div>
                                        <div class="text-emerald-600 font-black text-[9px] tracking-widest mt-1">${s.className} | ${s.gender || 'L/P'}</div>
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="window.editStudent('${s.id}')" class="p-2 text-blue-500 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition-all"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                        <button onclick="window.delStudent('${s.id}')" class="p-2 text-rose-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // UI: C8 LAPORAN HARIAN
        // ==========================================
        function renderReportsC8() {
            const dStr = new Date().toISOString().split('T')[0];
            
            // Auto calculate based on attendance data today (Default Hadir)
            const attToday = state.attendance[dStr] || {};
            const hadirToday = state.students.length - Object.values(attToday).filter(v => v === false).length;
            const jumlahRMT = state.students.length;

            return `
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-xl font-black uppercase tracking-tight">Laporan Harian (C8)</h2>
                        <p class="text-[9px] font-bold text-slate-400 uppercase mt-1">Modul Lengkap Jadual Excel</p>
                    </div>
                    <button onclick="window.preparePrint('C8')" class="bg-indigo-600 text-white px-5 py-3 rounded-xl font-bold text-[9px] uppercase shadow-lg flex items-center gap-2">
                        <i data-lucide="printer" class="w-4 h-4"></i> Cetak C8 (Log Rasmi)
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-4 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm h-fit">
                        <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest">Maklumat Laporan</h3>
                        <div class="space-y-4">
                            <div><label class="text-[9px] font-black text-slate-500 uppercase ml-1">Tarikh Semasa</label>
                            <input id="c8Date" type="date" value="${dStr}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-xs outline-none"></div>
                            
                            <div><label class="text-[9px] font-black text-slate-500 uppercase ml-1">Guru Bertugas</label>
                            <input id="c8Teacher" type="text" placeholder="NAMA GURU" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl uppercase font-bold text-xs outline-none"></div>
                            
                            <div><label class="text-[9px] font-black text-slate-500 uppercase ml-1">Menu RMT Hari Ini</label>
                            <input id="c8Menu" type="text" placeholder="CONTOH: NASI LEMAK" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl uppercase font-bold text-xs outline-none"></div>

                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-[9px] font-black text-slate-500 uppercase ml-1">Jum. Murid RMT</label>
                                <input type="number" value="${jumlahRMT}" readonly class="w-full p-3 bg-slate-200 border border-slate-300 rounded-xl uppercase font-bold text-xs text-center"></div>
                                <div><label class="text-[9px] font-black text-emerald-600 uppercase ml-1">Bil. Hadir Makan</label>
                                <input id="c8Hadir" type="number" value="${hadirToday}" class="w-full p-3 bg-emerald-50 border border-emerald-200 rounded-xl uppercase font-black text-emerald-700 text-xs text-center outline-none"></div>
                            </div>

                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200 space-y-3">
                                <p class="text-[10px] font-black uppercase text-slate-400 text-center border-b pb-2">Penilaian 4 Kriteria (Skor 1-4)</p>
                                <div><label class="text-[9px] font-bold text-slate-700 uppercase">1. Mengikut Menu</label>
                                <select id="c8SkorMenu" class="w-full p-2 bg-white border border-slate-200 rounded font-bold text-xs mt-1"><option value="4">4 - SANGAT MEMUASKAN</option><option value="3">3 - MEMUASKAN</option><option value="2">2 - KURANG MEMUASKAN</option><option value="1">1 - TIDAK MEMUASKAN</option></select></div>
                                
                                <div><label class="text-[9px] font-bold text-slate-700 uppercase">2. Kualiti Rasa</label>
                                <select id="c8SkorRasa" class="w-full p-2 bg-white border border-slate-200 rounded font-bold text-xs mt-1"><option value="4">4 - SANGAT MEMUASKAN</option><option value="3">3 - MEMUASKAN</option><option value="2">2 - KURANG MEMUASKAN</option><option value="1">1 - TIDAK MEMUASKAN</option></select></div>
                                
                                <div><label class="text-[9px] font-bold text-slate-700 uppercase">3. Kebersihan</label>
                                <select id="c8SkorBersih" class="w-full p-2 bg-white border border-slate-200 rounded font-bold text-xs mt-1"><option value="4">4 - SANGAT MEMUASKAN</option><option value="3">3 - MEMUASKAN</option><option value="2">2 - KURANG MEMUASKAN</option><option value="1">1 - TIDAK MEMUASKAN</option></select></div>
                                
                                <div><label class="text-[9px] font-bold text-slate-700 uppercase">4. Disiplin Murid</label>
                                <select id="c8SkorDisiplin" class="w-full p-2 bg-white border border-slate-200 rounded font-bold text-xs mt-1"><option value="4">4 - SANGAT MEMUASKAN</option><option value="3">3 - MEMUASKAN</option><option value="2">2 - KURANG MEMUASKAN</option><option value="1">1 - TIDAK MEMUASKAN</option></select></div>
                            </div>

                            <textarea id="c8Notes" placeholder="CATATAN / TINDAKAN" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl uppercase font-bold text-xs h-20 outline-none"></textarea>

                            <button onclick="window.addReportC8()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold uppercase text-[10px] tracking-widest shadow-lg">Simpan Laporan Harian</button>
                        </div>
                    </div>

                    <div class="lg:col-span-8 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                        <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest px-4">Arkib Rekod C8 (${state.reportsC8.length})</h3>
                        <div class="space-y-3 px-4">
                            ${state.reportsC8.map(r => `
                                <div class="p-4 bg-slate-50 rounded-2xl flex justify-between items-center border border-slate-100">
                                    <div>
                                        <div class="font-bold text-slate-800 text-xs">${r.date} <span class="text-slate-400">|</span> Guru: ${r.teacher}</div>
                                        <div class="flex flex-col gap-0.5 mt-2 text-[9px] uppercase font-bold text-indigo-600">
                                            <span>Menu: ${r.menu} <span class="text-slate-300 mx-1">|</span> Hadir: ${r.hadir}/${r.jum_rmt}</span>
                                            <span class="text-emerald-600">Skor: Menu(${r.s_menu}) Rasa(${r.s_rasa}) Bersih(${r.s_bersih}) Disiplin(${r.s_disiplin})</span>
                                        </div>
                                    </div>
                                    <button onclick="window.delReportC8('${r.id}')" class="p-2 text-rose-400 hover:text-rose-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // UI: C7 PEMANTAUAN
        // ==========================================
        function renderMonitoringC7() {
            return `
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-xl font-black uppercase tracking-tight">Pemantauan Pentadbir (C7)</h2>
                    <button onclick="window.preparePrint('C7')" class="bg-indigo-600 text-white px-5 py-3 rounded-xl font-bold text-[9px] uppercase shadow-lg flex items-center gap-2">
                        <i data-lucide="printer" class="w-4 h-4"></i> Cetak Borang C7
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-4 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm h-fit">
                        <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest">Input Pemantauan</h3>
                        <div class="space-y-4">
                            <input id="c7Date" type="date" value="${new Date().toISOString().split('T')[0]}" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-xs outline-none">
                            <input id="c7Admin" type="text" placeholder="NAMA PENTADBIR" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl uppercase font-bold text-xs outline-none">
                            
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                                <p class="text-[9px] font-bold uppercase text-slate-500 mb-2">Skor Pemantauan (1-4)</p>
                                <div class="grid grid-cols-2 gap-2 text-[9px] font-bold uppercase">
                                    <input id="c7s1" type="number" min="1" max="4" placeholder="Menu" class="p-2 border rounded">
                                    <input id="c7s2" type="number" min="1" max="4" placeholder="Rasa" class="p-2 border rounded">
                                    <input id="c7s3" type="number" min="1" max="4" placeholder="Bersih" class="p-2 border rounded">
                                    <input id="c7s4" type="number" min="1" max="4" placeholder="Disiplin" class="p-2 border rounded">
                                </div>
                            </div>

                            <textarea id="c7Notes" placeholder="ULASAN / MAKLUM BALAS" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl uppercase font-bold text-xs h-24 outline-none"></textarea>
                            <textarea id="c7Improv" placeholder="PENAMBAHBAIKAN" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl uppercase font-bold text-xs h-20 outline-none"></textarea>
                            <button onclick="window.addReportC7()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold uppercase text-[10px] tracking-widest shadow-lg">Simpan Laporan C7</button>
                        </div>
                    </div>
                    <div class="lg:col-span-8 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                        <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest">Rekod Pemantauan</h3>
                        <div class="space-y-3">
                            ${state.reportsC7.map(r => `
                                <div class="p-4 bg-slate-50 rounded-2xl flex justify-between items-center border border-slate-100">
                                    <div class="uppercase">
                                        <div class="font-bold text-slate-800 text-xs">${r.date}</div>
                                        <div class="text-emerald-600 font-black text-[9px] tracking-widest mt-1">PEMANTAU: ${r.admin}</div>
                                    </div>
                                    <button onclick="window.delReportC7('${r.id}')" class="p-2 text-rose-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // DATABASE FUNCTIONS
        // ==========================================
        window.confirmAttendance = async () => {
            const date = state.selectedDate;
            const records = state.attendance[date] || {};
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', date), { records, updatedAt: Date.now() });
            alert(`Selesai! Kehadiran bertarikh ${date} telah direkodkan.`);
        };

        window.resetAttendance = async () => {
            const date = state.selectedDate;
            if(confirm(`AWAS: Adakah anda pasti mahu memadam dan reset semula rekod kehadiran pukal untuk tarikh ${date}?`)) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', date));
            }
        };

        window.toggleAtt = async (id) => {
            const date = state.selectedDate;
            const records = state.attendance[date] || {};
            // Tukar antara Hadir (true/undefined) dan Tidak Hadir (false)
            records[id] = records[id] === false ? true : false;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', date), { records, updatedAt: Date.now() });
        };

        window.cancelEdit = () => {
            state.editStudentId = null;
            document.getElementById('stuName').value = ''; 
            document.getElementById('stuClass').value = '';
            document.getElementById('stuGender').value = 'L';
            document.getElementById('stuTinggiJan').value = '';
            document.getElementById('stuBeratJan').value = '';
            document.getElementById('stuTinggiNov').value = '';
            document.getElementById('stuBeratNov').value = '';
            document.getElementById('btnSubmitStudent').innerText = "Simpan ke Pangkalan Data";
            document.getElementById('btnCancelEdit').classList.add('hidden');
        };

        window.editStudent = (id) => {
            const student = state.students.find(s => s.id === id);
            if (student) {
                state.editStudentId = id;
                document.getElementById('stuName').value = student.name || '';
                document.getElementById('stuClass').value = student.className || '';
                document.getElementById('stuGender').value = student.gender || 'L';
                document.getElementById('stuTinggiJan').value = student.tinggiJan || '';
                document.getElementById('stuBeratJan').value = student.beratJan || '';
                document.getElementById('stuTinggiNov').value = student.tinggiNov || '';
                document.getElementById('stuBeratNov').value = student.beratNov || '';
                document.getElementById('btnSubmitStudent').innerText = "Kemas Kini Data";
                document.getElementById('btnCancelEdit').classList.remove('hidden');
                document.getElementById('stuName').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        };

        window.addStudent = async () => {
            const n = document.getElementById('stuName').value;
            const c = document.getElementById('stuClass').value;
            const g = document.getElementById('stuGender').value;
            
            const tj = document.getElementById('stuTinggiJan').value;
            const bj = document.getElementById('stuBeratJan').value;
            const tn = document.getElementById('stuTinggiNov').value;
            const bn = document.getElementById('stuBeratNov').value;

            if(!n || !c) return;
            const id = state.editStudentId || Date.now().toString();
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id), { 
                id, 
                name: n.toUpperCase(), 
                className: c.toUpperCase(), 
                gender: g,
                tinggiJan: tj,
                beratJan: bj,
                tinggiNov: tn,
                beratNov: bn
            });
            window.cancelEdit();
        };

        window.addBulk = async () => {
            const text = document.getElementById('bulkData').value;
            if(!text.trim()) {
                alert("Kotak data pukal kosong. Sila masukkan data terlebih dahulu.");
                return;
            }
            
            const lines = text.split('\n').filter(l => l.trim() !== "");
            let count = 0;
            let fail = 0;
            
            for(let line of lines) {
                // Pecahkan guna koma (,) ATAU tab (\t) untuk menyokong copy-paste dari Excel
                const parts = line.split(/[\t,]+/).map(p => p.trim()).filter(p => p !== "");
                
                if(parts.length >= 2) {
                    const id = crypto.randomUUID ? crypto.randomUUID() : "std_" + Date.now() + "_" + Math.floor(Math.random() * 10000);
                    
                    // Buang nombor senarai di hadapan jika ada (Cth: "1. ALI" -> "ALI")
                    let name = parts[0].toUpperCase().replace(/^\d+[\.\)]\s*/, '');
                    let className = parts[1].toUpperCase();
                    let gender = "L"; // Default Lelaki
                    
                    if (parts.length > 2) {
                        gender = parts[2].toUpperCase().startsWith('P') ? 'P' : 'L';
                    }

                    try {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id), { 
                            id, name: name, className: className, gender: gender, updatedAt: Date.now() 
                        });
                        count++;
                    } catch (e) {
                        console.error("Ralat menyimpan data:", e);
                        fail++;
                    }
                } else {
                    fail++;
                }
            }
            
            document.getElementById('bulkData').value = ''; 
            alert(`Proses Selesai!\n\n✅ Berjaya didaftar: ${count} murid\n❌ Gagal / Format salah: ${fail} baris`);
        };

        window.delStudent = async (id) => { if(confirm('Padam data murid?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id)); };

        window.addReportC8 = async () => {
            const d = document.getElementById('c8Date').value;
            const t = document.getElementById('c8Teacher').value;
            const menu = document.getElementById('c8Menu').value;
            const jumRMT = state.students.length;
            const hadir = document.getElementById('c8Hadir').value;
            
            const s1 = document.getElementById('c8SkorMenu').value;
            const s2 = document.getElementById('c8SkorRasa').value;
            const s3 = document.getElementById('c8SkorBersih').value;
            const s4 = document.getElementById('c8SkorDisiplin').value;
            const notes = document.getElementById('c8Notes').value;

            if(!t || !menu) { alert('Sila isi Guru & Menu.'); return; }
            
            const dayNames = ['AHAD', 'ISNIN', 'SELASA', 'RABU', 'KHAMIS', 'JUMAAT', 'SABTU'];
            const hari = dayNames[new Date(d).getDay()];

            const id = Date.now().toString();
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reportsC8', id), { 
                id, date: d, day: hari, teacher: t.toUpperCase(), menu: menu.toUpperCase(), 
                jum_rmt: jumRMT, hadir: hadir, s_menu: s1, s_rasa: s2, s_bersih: s3, s_disiplin: s4,
                notes: notes.toUpperCase() || 'TIADA', updatedAt: Date.now() 
            });
            document.getElementById('c8Menu').value = ''; document.getElementById('c8Notes').value = '';
        };

        window.delReportC8 = async (id) => { if(confirm('Padam laporan?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reportsC8', id)); };

        window.addReportC7 = async () => {
            const d = document.getElementById('c7Date').value;
            const a = document.getElementById('c7Admin').value;
            const n = document.getElementById('c7Notes').value;
            const p = document.getElementById('c7Improv').value;
            const s1 = document.getElementById('c7s1').value || 4;
            const s2 = document.getElementById('c7s2').value || 4;
            const s3 = document.getElementById('c7s3').value || 4;
            const s4 = document.getElementById('c7s4').value || 4;
            if(!a) return;
            const dayNames = ['AHAD', 'ISNIN', 'SELASA', 'RABU', 'KHAMIS', 'JUMAAT', 'SABTU'];
            const hari = dayNames[new Date(d).getDay()];

            const id = Date.now().toString();
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reportsC7', id), { 
                id, date: d, day: hari, admin: a.toUpperCase(), notes: n.toUpperCase(), improv: p.toUpperCase(),
                s1, s2, s3, s4, updatedAt: Date.now() 
            });
            document.getElementById('c7Admin').value = ''; document.getElementById('c7Notes').value = ''; document.getElementById('c7Improv').value = '';
        };

        window.delReportC7 = async (id) => { if(confirm('Padam?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reportsC7', id)); };


        // ==========================================
        // PRINTING ENGINE (EXCEL KPM FORMAT)
        // ==========================================
        window.preparePrint = (mode) => {
            const overlay = document.getElementById('print-overlay');
            const area = document.getElementById('print-area');
            overlay.classList.remove('hidden');
            document.body.classList.remove('portrait-mode');

            if (mode === 'C8') {
                document.title = "Cetak_C8_RMT";
                
                // Bina struktur jadual C8 Excel
                let tbodyRows = '';
                state.reportsC8.forEach((r, idx) => {
                    tbodyRows += `
                        <tr>
                            <td rowspan="4" class="border border-black p-2 text-center font-bold">${idx+1}</td>
                            <td rowspan="4" class="border border-black p-2 text-center font-bold">${r.day || ''}<br>${r.date}</td>
                            <td rowspan="4" class="border border-black p-2 text-center">${r.teacher}</td>
                            <td rowspan="4" class="border border-black p-2 text-center font-black text-sm">${r.hadir || '-'}</td>
                            <td class="border border-black p-1 text-left px-2">1. Mengikut menu</td>
                            <td class="border border-black p-1 text-center font-bold">${r.s_menu || 4}</td>
                            <td rowspan="4" class="border border-black p-2 text-left px-2 italic">${r.notes || ''}</td>
                            <td rowspan="4" class="border border-black p-2"></td>
                            <td rowspan="4" class="border border-black p-2"></td>
                        </tr>
                        <tr><td class="border border-black p-1 text-left px-2">2. Kualiti rasa</td><td class="border border-black p-1 text-center font-bold">${r.s_rasa || 4}</td></tr>
                        <tr><td class="border border-black p-1 text-left px-2">3. Kebersihan</td><td class="border border-black p-1 text-center font-bold">${r.s_bersih || 4}</td></tr>
                        <tr><td class="border border-black p-1 text-left px-2">4. Disiplin murid</td><td class="border border-black p-1 text-center font-bold">${r.s_disiplin || 4}</td></tr>
                    `;
                });

                if(state.reportsC8.length === 0) tbodyRows = '<tr><td colspan="9" class="border border-black p-10 text-center uppercase font-bold text-slate-400">Tiada Rekod C8 Ditemui</td></tr>';

                area.innerHTML = `
                    <div class="text-right font-bold text-xs mb-2">BORANG C8</div>
                    <div class="text-center mb-6 uppercase">
                        <h1 class="text-sm font-black underline">LAPORAN HARIAN RANCANGAN MAKANAN TAMBAHAN (RMT)</h1>
                    </div>
                    <table class="w-full text-[8px] uppercase border-collapse border border-black text-center">
                        <thead class="bg-gray-100 font-bold">
                            <tr>
                                <th class="border border-black p-2 w-10">BIL HARI</th>
                                <th class="border border-black p-2 w-24">HARI / TARIKH</th>
                                <th class="border border-black p-2 w-32">GURU BERTUGAS</th>
                                <th class="border border-black p-2 w-20">BIL. MURID HADIR</th>
                                <th class="border border-black p-2 w-32">KRITERIA</th>
                                <th class="border border-black p-2 w-16">SKOR (1-4)</th>
                                <th class="border border-black p-2 w-48">CATATAN</th>
                                <th class="border border-black p-2 w-32">TANDATANGAN GURU</th>
                                <th class="border border-black p-2 w-32">TANDATANGAN PENGUSAHA</th>
                            </tr>
                        </thead>
                        <tbody>${tbodyRows}</tbody>
                    </table>
                    <div class="mt-4 text-[8px] font-bold flex gap-4">
                        <div>PETUNJUK SKOR:</div>
                        <div>1: TIDAK MEMUASKAN</div>
                        <div>2: KURANG MEMUASKAN</div>
                        <div>3: MEMUASKAN</div>
                        <div>4: SANGAT MEMUASKAN</div>
                    </div>
                    <div class="signature-space mt-10">
                        <div class="sig-box">DISEMAK OLEH:<br><br><br>(GURU BESAR/GPK HEM)</div>
                    </div>
                `;
            } else if (mode === 'C1') {
                document.body.classList.add('portrait-mode');
                document.title = "Cetak_C1_RMT";
                
                area.innerHTML = `
                    <div class="text-right font-bold text-xs mb-2">BORANG C1</div>
                    <div class="text-center mb-6 uppercase">
                        <h1 class="text-sm font-black underline">REKOD FIZIKAL MURID</h1>
                        <div class="flex justify-between mt-4 px-10 font-bold text-xs text-left">
                            <div>NAMA SEKOLAH : SK SUNGAI HAJI DORANI<br>KOD SEKOLAH : (KOD)<br>DAERAH : SABAK BERNAM</div>
                            <div>NEGERI : SELANGOR</div>
                        </div>
                    </div>
                    <table class="w-full text-[8px] uppercase border-collapse border border-black text-center">
                        <thead class="bg-gray-100 font-bold">
                            <tr>
                                <th rowspan="2" class="border border-black p-1 w-10">BIL</th>
                                <th rowspan="2" class="border border-black p-1 text-left px-2">NAMA MURID</th>
                                <th rowspan="2" class="border border-black p-1 w-20">TAHUN / KELAS</th>
                                <th colspan="4" class="border border-black p-1">MAKLUMAT TINGGI DAN BERAT</th>
                            </tr>
                            <tr>
                                <th class="border border-black p-1 w-16">TINGGI (M) JAN</th>
                                <th class="border border-black p-1 w-16">TINGGI (M) NOV</th>
                                <th class="border border-black p-1 w-16">BERAT (KG) JAN</th>
                                <th class="border border-black p-1 w-16">BERAT (KG) NOV</th>
                            </tr>
                        </thead>
                        <tbody>${state.students.map((s, i) => `
                            <tr>
                                <td class="border border-black p-1">${i+1}</td>
                                <td class="border border-black p-1 text-left px-2 font-bold">${s.name}</td>
                                <td class="border border-black p-1">${s.className}</td>
                                <td class="border border-black p-1">${s.tinggiJan || ''}</td>
                                <td class="border border-black p-1">${s.tinggiNov || ''}</td>
                                <td class="border border-black p-1">${s.beratJan || ''}</td>
                                <td class="border border-black p-1">${s.beratNov || ''}</td>
                            </tr>
                        `).join('')}</tbody>
                    </table>
                `;
            } else if (mode === 'C2') {
                document.body.classList.add('portrait-mode');
                document.title = "Cetak_C2_RMT";
                
                area.innerHTML = `
                    <div class="text-right font-bold text-xs mb-2">BORANG C2</div>
                    <div class="text-center mb-6 uppercase">
                        <h1 class="text-sm font-black underline">REKOD AKADEMIK MURID</h1>
                        <div class="flex justify-between mt-4 px-10 font-bold text-xs text-left">
                            <div>NAMA SEKOLAH : SK SUNGAI HAJI DORANI<br>KOD SEKOLAH : (KOD)<br>DAERAH : SABAK BERNAM</div>
                        </div>
                    </div>
                    <table class="w-full text-[8px] uppercase border-collapse border border-black text-center">
                        <thead class="bg-gray-100 font-bold">
                            <tr>
                                <th rowspan="2" class="border border-black p-1 w-10">BIL</th>
                                <th rowspan="2" class="border border-black p-1 text-left px-2">NAMA MURID</th>
                                <th rowspan="2" class="border border-black p-1 w-20">KELAS</th>
                                <th colspan="2" class="border border-black p-1">PERATUS KEHADIRAN</th>
                                <th colspan="2" class="border border-black p-1">PRESTASI KEHADIRAN (MENINGKAT/MENURUN)</th>
                            </tr>
                            <tr>
                                <th class="border border-black p-1 w-16">TOV</th>
                                <th class="border border-black p-1 w-16">AR</th>
                                <th class="border border-black p-1 w-24">NOV TAHUN SEBELUM</th>
                                <th class="border border-black p-1 w-24">NOV TAHUN SEMASA</th>
                            </tr>
                        </thead>
                        <tbody>${state.students.map((s, i) => `
                            <tr>
                                <td class="border border-black p-1">${i+1}</td>
                                <td class="border border-black p-1 text-left px-2 font-bold">${s.name}</td>
                                <td class="border border-black p-1">${s.className}</td>
                                <td class="border border-black p-1"></td><td class="border border-black p-1"></td><td class="border border-black p-1"></td><td class="border border-black p-1"></td>
                            </tr>
                        `).join('')}</tbody>
                    </table>
                `;
            } else if (mode === 'C3') {
                document.body.classList.add('portrait-mode');
                document.title = "Cetak_C3_RMT";
                
                area.innerHTML = `
                    <div class="text-right font-bold text-xs mb-2">BORANG C3</div>
                    <div class="text-center mb-6 uppercase">
                        <h1 class="text-sm font-black underline">JADUAL GURU BERTUGAS RMT TAHUN 2026</h1>
                    </div>
                    <table class="w-full text-[10px] uppercase border-collapse border border-black text-center">
                        <thead class="bg-gray-100 font-bold">
                            <tr>
                                <th class="border border-black p-3">HARI / MASA</th>
                                <th class="border border-black p-3">PAGI</th>
                                <th class="border border-black p-3">REHAT PERTAMA</th>
                                <th class="border border-black p-3">REHAT KEDUA</th>
                                <th class="border border-black p-3">PPKI</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td class="border border-black p-3 font-bold">ISNIN</td><td class="border border-black p-3"></td><td class="border border-black p-3">GURU MINGGUAN</td><td class="border border-black p-3">GURU MINGGUAN</td><td class="border border-black p-3"></td></tr>
                            <tr><td class="border border-black p-3 font-bold">SELASA</td><td class="border border-black p-3"></td><td class="border border-black p-3">GURU MINGGUAN</td><td class="border border-black p-3">GURU MINGGUAN</td><td class="border border-black p-3"></td></tr>
                            <tr><td class="border border-black p-3 font-bold">RABU</td><td class="border border-black p-3"></td><td class="border border-black p-3">GURU MINGGUAN</td><td class="border border-black p-3">GURU MINGGUAN</td><td class="border border-black p-3"></td></tr>
                            <tr><td class="border border-black p-3 font-bold">KHAMIS</td><td class="border border-black p-3"></td><td class="border border-black p-3">GURU MINGGUAN</td><td class="border border-black p-3">GURU MINGGUAN</td><td class="border border-black p-3"></td></tr>
                            <tr><td class="border border-black p-3 font-bold">JUMAAT</td><td class="border border-black p-3"></td><td class="border border-black p-3">GURU MINGGUAN</td><td class="border border-black p-3">GURU MINGGUAN</td><td class="border border-black p-3"></td></tr>
                        </tbody>
                    </table>
                `;
            } else if (mode === 'C4') {
                document.body.classList.add('portrait-mode');
                document.title = "Cetak_C4_RMT";
                area.innerHTML = `
                    <div class="text-right font-bold text-xs mb-2">BORANG C4</div>
                    <div class="text-center mb-6 uppercase">
                        <h1 class="text-sm font-black underline">SENARAI PENERIMA MURID RMT TAHUN 2026</h1>
                        <p class="font-bold mt-1">SEKOLAH: SK SUNGAI HAJI DORANI</p>
                    </div>
                    <table class="w-full text-[10px] uppercase border-collapse border border-black">
                        <thead class="bg-gray-100 font-bold"><tr>
                            <th class="border border-black p-2 w-12 text-center">BIL</th>
                            <th class="border border-black p-2 text-left px-4">NAMA</th>
                            <th class="border border-black p-2 w-32 text-center">KELAS</th>
                        </tr></thead>
                        <tbody>${state.students.map((s, i) => `
                            <tr><td class="border border-black text-center p-2">${i+1}</td><td class="border border-black p-2 px-4 font-bold">${s.name}</td><td class="border border-black text-center p-2">${s.className}</td></tr>
                        `).join('')}</tbody>
                    </table>
                `;
            } else if (mode === 'C7') {
                document.body.classList.add('portrait-mode');
                document.title = "Cetak_C7_RMT";
                
                let c7List = '';
                state.reportsC7.forEach(r => {
                    c7List += `
                        <div class="page-break">
                            <div class="text-right font-bold text-xs mb-2">BORANG C7</div>
                            <h1 class="text-center text-sm font-black underline mb-6 uppercase">LAPORAN PEMANTAUAN GURU BESAR / GURU PENOLONG KANAN HEM</h1>
                            <div class="text-xs uppercase space-y-4 mb-4 font-bold">
                                <div>HARI: ${r.day || ''} &nbsp;&nbsp;&nbsp; TARIKH: ${r.date} &nbsp;&nbsp;&nbsp; MASA: ...................</div>
                            </div>
                            <div class="text-xs uppercase space-y-2 mb-6">
                                <p class="font-bold underline">A. MAKLUMAT PENTADBIR SEKOLAH</p>
                                <p>NAMA GURU BESAR / GPK HEM : ${r.admin}</p>
                                <p>NAMA GURU BERTUGAS : ..............................................................</p>
                            </div>
                            <div class="text-xs uppercase space-y-2 mb-6">
                                <p class="font-bold underline">B. MAKLUMAT MURID</p>
                                <p>BIL. MURID : .....................</p>
                                <p>BIL. KEHADIRAN : .....................</p>
                            </div>
                            <div class="text-xs uppercase space-y-2 mb-6">
                                <p class="font-bold underline">C. DAPATAN PEMANTAUAN</p>
                                <table class="w-full mt-2 text-center border-collapse border border-black">
                                    <thead class="bg-gray-100 font-bold">
                                        <tr><th rowspan="2" class="border border-black p-2 text-left px-2">ITEM</th><th colspan="4" class="border border-black p-1">SKOR</th></tr>
                                        <tr class="text-[8px]"><th class="border border-black w-16">1<br>TIDAK MEMUASKAN</th><th class="border border-black w-16">2<br>KURANG MEMUASKAN</th><th class="border border-black w-16">3<br>MEMUASKAN</th><th class="border border-black w-16">4<br>SANGAT MEMUASKAN</th></tr>
                                    </thead>
                                    <tbody>
                                        <tr><td class="border border-black p-1 text-left px-2 font-bold">MENGIKUT MENU</td><td class="border border-black p-1">${r.s1==1?'/':''}</td><td class="border border-black p-1">${r.s1==2?'/':''}</td><td class="border border-black p-1">${r.s1==3?'/':''}</td><td class="border border-black p-1">${r.s1==4?'/':''}</td></tr>
                                        <tr><td class="border border-black p-1 text-left px-2 font-bold">KUALITI RASA</td><td class="border border-black p-1">${r.s2==1?'/':''}</td><td class="border border-black p-1">${r.s2==2?'/':''}</td><td class="border border-black p-1">${r.s2==3?'/':''}</td><td class="border border-black p-1">${r.s2==4?'/':''}</td></tr>
                                        <tr><td class="border border-black p-1 text-left px-2 font-bold">KEBERSIHAN</td><td class="border border-black p-1">${r.s3==1?'/':''}</td><td class="border border-black p-1">${r.s3==2?'/':''}</td><td class="border border-black p-1">${r.s3==3?'/':''}</td><td class="border border-black p-1">${r.s3==4?'/':''}</td></tr>
                                        <tr><td class="border border-black p-1 text-left px-2 font-bold">DISIPLIN MURID</td><td class="border border-black p-1">${r.s4==1?'/':''}</td><td class="border border-black p-1">${r.s4==2?'/':''}</td><td class="border border-black p-1">${r.s4==3?'/':''}</td><td class="border border-black p-1">${r.s4==4?'/':''}</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-xs uppercase space-y-2 mb-10">
                                <p class="font-bold">ULASAN / MAKLUM BALAS :</p>
                                <div class="p-4 border border-black h-24 italic">${r.notes || ''}</div>
                                <div class="signature-space mt-2"><div class="sig-box">Tandatangan :</div><div class="sig-box">Cap dan Tarikh :</div></div>
                            </div>
                            <div class="text-xs uppercase space-y-2">
                                <p class="font-bold">PENAMBAHBAIKAN :</p>
                                <div class="p-4 border border-black h-24 italic">${r.improv || ''}</div>
                                <div class="signature-space mt-2"><div class="sig-box">Tandatangan :</div><div class="sig-box">Cap dan Tarikh :</div></div>
                            </div>
                        </div>
                    `;
                });
                if(state.reportsC7.length === 0) c7List = '<p class="text-center font-bold">TIADA REKOD PEMANTAUAN.</p>';
                area.innerHTML = c7List;

            } else if (mode === 'C9_MONTH') {
                document.title = "Cetak_C9_RMT";
                const [y, m] = state.printMonth.split('-').map(Number);
                const mName = new Date(y, m-1).toLocaleString('ms-MY', { month: 'long', year: 'numeric' });
                const totalDays = new Date(y, m, 0).getDate();
                const todayStr = new Date().toISOString().split('T')[0];
                
                area.innerHTML = `
                    <div class="text-right font-bold text-xs mb-2">BORANG C9</div>
                    <div class="text-left mb-6 uppercase">
                        <h1 class="text-sm font-black underline">REKOD KEHADIRAN MURID RMT</h1>
                    </div>
                    <table class="w-full text-[6px] text-center uppercase border-collapse border border-black">
                        <thead class="bg-gray-100 font-bold">
                            <tr>
                                <th rowspan="2" class="border border-black p-1 w-6">BIL</th>
                                <th rowspan="2" class="border border-black p-1 text-left px-2 w-48">NAMA PENUH MURID</th>
                                <th rowspan="2" class="border border-black p-1">TAHUN</th>
                                <th rowspan="2" class="border border-black p-1">JANTINA</th>
                                <th colspan="${totalDays}" class="border border-black p-1">BULAN ${mName}</th>
                                <th colspan="3" class="border border-black p-1">JUMLAH HARI</th>
                                <th rowspan="2" class="border border-black p-1">TIDAK<br>HADIR</th>
                            </tr>
                            <tr>
                                ${[...Array(totalDays)].map((_, i) => `<th class="border border-black bg-gray-50 w-3">${i+1}</th>`).join('')}
                                <th class="border border-black p-1 w-8 leading-tight">BULAN<br>SEMASA</th>
                                <th class="border border-black p-1 w-8 leading-tight">BULAN<br>LEPAS</th>
                                <th class="border border-black p-1 w-8 leading-tight">JUMLAH<br>SEMUA</th>
                            </tr>
                        </thead>
                        <tbody>${state.students.map((s, i) => {
                            let countHadir = 0;
                            let countTidakHadir = 0;
                            return `<tr>
                                <td class="border border-black p-1">${i+1}</td>
                                <td class="border border-black text-left px-2 truncate">${s.name}</td>
                                <td class="border border-black p-1">${s.className}</td>
                                <td class="border border-black p-1">${s.gender || ''}</td>
                                ${[...Array(totalDays)].map((_, di) => {
                                    const dKey = `${y}-${String(m).padStart(2,'0')}-${String(di+1).padStart(2,'0')}`;
                                    const dow = new Date(dKey).getDay();
                                    const dateRecord = state.attendance[dKey];
                                    
                                    if (dow === 0 || dow === 6) return `<td class="border border-black bg-gray-200"></td>`;
                                    if (dKey > todayStr) return `<td class="border border-black"></td>`; // Kosongkan hari akan datang
                                    
                                    // HANYA LETAK TANDA JIKA KEHADIRAN TELAH DISAHKAN PADA TARIKH INI
                                    if (!dateRecord) return `<td class="border border-black"></td>`;
                                    
                                    const status = dateRecord[s.id];
                                    if (status !== false) { countHadir++; return `<td class="border border-black font-bold">/</td>`; }
                                    countTidakHadir++; return `<td class="border border-black text-red-600 font-black">O</td>`;
                                }).join('')}
                                <td class="border border-black font-bold text-sm">${countHadir}</td>
                                <td class="border border-black"></td>
                                <td class="border border-black"></td>
                                <td class="border border-black font-bold text-sm text-red-600">${countTidakHadir}</td>
                            </tr>`
                        }).join('')}</tbody>
                    </table>
                `;
            }
        };

        // Initialize App
        onAuthStateChanged(auth, async (user) => {
            if (!user) { await signInAnonymously(auth); return; }
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'students'), (snap) => {
                // Susun ikut KELAS dahulu, kemudian baru ikut NAMA
                state.students = snap.docs.map(d => d.data()).sort((a, b) => {
                    const classA = a.className || '';
                    const classB = b.className || '';
                    const classCompare = classA.localeCompare(classB);
                    
                    if (classCompare !== 0) {
                        return classCompare; // Jika kelas berbeza, susun ikut kelas
                    }
                    
                    // Jika kelas sama, susun ikut nama
                    const nameA = a.name || '';
                    const nameB = b.name || '';
                    return nameA.localeCompare(nameB);
                });
                
                document.getElementById('loader').classList.add('opacity-0', 'pointer-events-none');
                render();
            }, (e) => showError("Ralat Firestore. Sila periksa Rules pangkalan data anda."));
            
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), (snap) => {
                // BUG FIX: Mengosongkan data lama supaya tarikh yang dipadam terus terpadam di UI
                const newAtt = {};
                snap.docs.forEach(d => newAtt[d.id] = d.data().records);
                state.attendance = newAtt;
                render();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'reportsC8'), (snap) => {
                // Susun ikut kronologi tarikh: paling lama ke paling baru (ascending)
                state.reportsC8 = snap.docs.map(d => d.data()).sort((a,b) => a.date.localeCompare(b.date));
                render();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'reportsC7'), (snap) => {
                // Susun ikut kronologi tarikh: paling lama ke paling baru (ascending)
                state.reportsC7 = snap.docs.map(d => d.data()).sort((a,b) => a.date.localeCompare(b.date));
                render();
            });
        });
    </script>
</body>
</html>
