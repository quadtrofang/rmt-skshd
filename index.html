<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem RMT SKSHD - Rasmi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        @media print { .no-print { display: none !important; } .print-area { display: block !important; } }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .tab-active { background-color: #059669; color: white; box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.2); }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-800 text-sm h-screen flex flex-col overflow-hidden">

    <!-- SCREEN LOADING -->
    <div id="loader" class="fixed inset-0 bg-slate-900 z-[9999] flex flex-col items-center justify-center text-white p-6 transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4 shadow-lg shadow-emerald-500/20"></div>
        <p id="loading-text" class="font-bold text-[10px] uppercase tracking-[0.3em] text-emerald-400">Menyambung Awan SKSHD...</p>
        <div id="error-box" class="hidden mt-6 p-4 bg-rose-500/10 border border-rose-500/50 rounded-2xl max-w-sm w-full text-center">
            <p id="error-msg" class="text-rose-300 text-xs font-medium"></p>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <!-- SIDEBAR (DESKTOP) -->
        <aside class="hidden md:flex flex-col w-64 bg-slate-900 text-white no-print">
            <div class="p-6 bg-slate-950 border-b border-slate-800">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-emerald-500 rounded-xl shadow-lg shadow-emerald-500/20"><i data-lucide="cloud" class="w-5 h-5 text-white"></i></div>
                    <div>
                        <h1 class="font-black text-xs uppercase tracking-tighter leading-none">Sistem RMT</h1>
                        <p class="text-[7px] font-bold text-emerald-400 uppercase mt-1 tracking-widest">SK Sg Haji Dorani</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto custom-scroll">
                <button onclick="window.setTab('dash')" id="nav-dash" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all font-bold text-[10px] uppercase tracking-widest text-slate-400 hover:bg-slate-800">
                    <i data-lucide="check-square" class="w-4 h-4"></i> <span>Kehadiran (C9)</span>
                </button>
                <button onclick="window.setTab('stu')" id="nav-stu" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all font-bold text-[10px] uppercase tracking-widest text-slate-400 hover:bg-slate-800">
                    <i data-lucide="users" class="w-4 h-4"></i> <span>Urus Murid (C4)</span>
                </button>
                <button onclick="window.setTab('rep')" id="nav-rep" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all font-bold text-[10px] uppercase tracking-widest text-slate-400 hover:bg-slate-800">
                    <i data-lucide="clipboard-list" class="w-4 h-4"></i> <span>Laporan (C8)</span>
                </button>
                <button onclick="window.setTab('mon')" id="nav-mon" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all font-bold text-[10px] uppercase tracking-widest text-slate-400 hover:bg-slate-800">
                    <i data-lucide="shield-check" class="w-4 h-4"></i> <span>Pemantauan (C7)</span>
                </button>
            </nav>
        </aside>

        <!-- MAIN AREA -->
        <div class="flex-1 flex flex-col overflow-hidden relative">
            <!-- Mobile Navigation -->
            <header class="md:hidden bg-slate-900 text-white p-3 flex justify-between items-center no-print shadow-xl">
                <div class="flex items-center gap-2">
                    <i data-lucide="cloud" class="w-4 h-4 text-emerald-400"></i>
                    <span class="font-black uppercase text-[10px] tracking-tight">RMT SKSHD</span>
                </div>
                <div class="flex gap-1">
                    <button onclick="window.setTab('dash')" class="p-2"><i data-lucide="check-square" class="w-4 h-4"></i></button>
                    <button onclick="window.setTab('stu')" class="p-2"><i data-lucide="users" class="w-4 h-4"></i></button>
                    <button onclick="window.setTab('rep')" class="p-2"><i data-lucide="clipboard-list" class="w-4 h-4"></i></button>
                    <button onclick="window.setTab('mon')" class="p-2"><i data-lucide="shield-check" class="w-4 h-4"></i></button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-4 md:p-8 custom-scroll">
                <div id="main-content" class="max-w-5xl mx-auto"></div>
            </main>

            <!-- PRINT OVERLAY -->
            <div id="print-overlay" class="fixed inset-0 bg-white z-[5000] hidden overflow-y-auto p-8 text-black">
                <div class="no-print mb-8 flex justify-between items-center sticky top-0 bg-white/90 backdrop-blur-md p-4 border-b">
                    <h3 class="font-black uppercase text-xs">Pratinjau Cetakan</h3>
                    <div class="flex gap-2">
                        <button onclick="window.print()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold text-[10px] uppercase shadow-lg">Cetak Sekarang</button>
                        <button onclick="document.getElementById('print-overlay').classList.add('hidden')" class="bg-slate-100 text-slate-500 px-6 py-2 rounded-lg font-bold text-[10px] uppercase">Tutup</button>
                    </div>
                </div>
                <div id="print-area" class="max-w-[210mm] mx-auto bg-white border border-slate-200 p-10 shadow-2xl"></div>
            </div>
        </div>
    </div>

    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // ============================================================
        // ⚠️ PASTE KUNCI FIREBASE ANDA DI DALAM { } DI BAWAH INI
        // ============================================================
        const firebaseConfig = {
            // apiKey: "...", 
            // authDomain: "...", dsb.
        };

        const showError = (m) => {
            document.getElementById('loading-text').innerText = "RALAT";
            const eb = document.getElementById('error-box');
            eb.classList.remove('hidden');
            document.getElementById('error-msg').innerText = m;
        };

        let db, auth;
        try {
            if (!firebaseConfig.apiKey) throw new Error("Kunci Firebase tidak dijumpai. Sila masukkan config anda.");
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) { showError(e.message); }

        const appId = "skshd-rmt-cloud-v2";
        let state = {
            tab: 'dash',
            students: [],
            attendance: {},
            reportsC8: [],
            reportsC7: [],
            loading: true
        };

        window.setTab = (t) => { state.tab = t; render(); };

        function render() {
            const content = document.getElementById('main-content');
            
            // Nav Highlighting
            document.querySelectorAll('aside nav button').forEach(b => b.classList.remove('tab-active'));
            const activeNav = document.getElementById(`nav-${state.tab}`);
            if (activeNav) activeNav.classList.add('tab-active');

            if (state.tab === 'dash') content.innerHTML = renderDashboard();
            else if (state.tab === 'stu') content.innerHTML = renderStudents();
            else if (state.tab === 'rep') content.innerHTML = renderReportsC8();
            else if (state.tab === 'mon') content.innerHTML = renderMonitoringC7();

            lucide.createIcons();
        }

        // --- DASHBOARD (C9) ---
        function renderDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const att = state.attendance[today] || {};
            const hadir = Object.values(att).filter(v => v).length;

            return `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-black uppercase tracking-tight">Kehadiran Harian (C9)</h2>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">${today}</p>
                    </div>
                    <button onclick="window.preparePrint('C9')" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl font-bold text-[10px] uppercase flex items-center gap-2 shadow-xl hover:bg-slate-800 transition-all">
                        <i data-lucide="printer" class="w-3.5 h-3.5"></i> Cetak C9
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                        <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Jumlah Murid</p>
                        <p class="text-2xl font-black text-slate-800 leading-none">${state.students.length}</p>
                    </div>
                    <div class="bg-emerald-50 p-5 rounded-2xl border border-emerald-100 shadow-sm text-emerald-700">
                        <p class="text-[8px] font-black uppercase tracking-widest mb-1">Makan Hari Ini</p>
                        <p class="text-2xl font-black leading-none">${hadir}</p>
                    </div>
                </div>

                <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-slate-50 border-b border-slate-100 text-[9px] uppercase font-bold text-slate-400">
                            <tr><th class="p-5 w-16 text-center">BIL</th><th class="p-5">PROFIL MURID</th><th class="p-5 text-center">STATUS</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            ${state.students.map((s, i) => `
                                <tr class="hover:bg-slate-50/50">
                                    <td class="p-5 text-center font-bold text-slate-300">${i+1}</td>
                                    <td class="p-5 uppercase font-bold text-slate-700 leading-tight">
                                        ${s.name} <br><span class="text-[8px] font-black text-slate-400">${s.className}</span>
                                    </td>
                                    <td class="p-5 text-center">
                                        <button onclick="window.toggleAtt('${s.id}')" class="px-5 py-2 rounded-xl font-black text-[9px] uppercase transition-all shadow-md active:scale-90 ${att[s.id] ? 'bg-emerald-500 text-white border-b-4 border-emerald-700' : 'bg-slate-100 text-slate-400 border-b-4 border-slate-200'}">
                                            ${att[s.id] ? 'Makan' : 'Ponteng'}
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // --- URUS MURID (C4) ---
        function renderStudents() {
            return `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black uppercase tracking-tight">Pengurusan Murid</h2>
                    <button onclick="window.preparePrint('C4')" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl font-bold text-[10px] uppercase flex items-center gap-2 shadow-xl hover:bg-slate-800 transition-all">
                        <i data-lucide="printer" class="w-3.5 h-3.5"></i> Borang C4
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    <div class="lg:col-span-4 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                        <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest">Daftar Murid</h3>
                        <div class="space-y-4">
                            <input id="stuName" type="text" placeholder="NAMA PENUH" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl uppercase font-bold text-xs outline-none focus:border-emerald-500 transition-all">
                            <input id="stuClass" type="text" placeholder="KELAS (CTH: 1A)" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl uppercase font-bold text-xs outline-none focus:border-emerald-500 transition-all">
                            <button onclick="window.addStudent()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold uppercase text-[9px] tracking-[0.2em] shadow-xl hover:bg-slate-800 transition-all active:scale-95">Simpan Data</button>
                        </div>
                    </div>
                    <div class="lg:col-span-8 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                        <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest">Senarai Penerima (${state.students.length})</h3>
                        <div class="space-y-2">
                            ${state.students.map(s => `
                                <div class="p-4 bg-slate-50 rounded-2xl flex justify-between items-center group transition-all hover:bg-white hover:shadow-lg border border-transparent hover:border-slate-100">
                                    <div class="uppercase">
                                        <div class="font-bold text-slate-700 text-xs">${s.name}</div>
                                        <div class="text-emerald-500 font-black text-[8px] tracking-widest leading-none mt-1">${s.className}</div>
                                    </div>
                                    <button onclick="window.delStudent('${s.id}')" class="p-2 text-slate-300 hover:text-rose-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- LAPORAN HARIAN (C8) ---
        function renderReportsC8() {
            return `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black uppercase tracking-tight">Laporan Harian (C8)</h2>
                    <button onclick="window.preparePrint('C8')" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold text-[10px] uppercase flex items-center gap-2 shadow-xl hover:bg-indigo-700 transition-all">
                        <i data-lucide="printer" class="w-3.5 h-3.5"></i> Koleksi C8
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    <div class="lg:col-span-4 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                        <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest">Input Laporan Harian</h3>
                        <div class="space-y-4">
                            <input id="c8Date" type="date" value="${new Date().toISOString().split('T')[0]}" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold text-xs">
                            <input id="c8Teacher" type="text" placeholder="NAMA GURU" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl uppercase font-bold text-xs">
                            <textarea id="c8Notes" placeholder="ULASAN KUALITI MAKANAN" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl uppercase font-bold text-xs h-24 outline-none focus:border-emerald-500"></textarea>
                            <button onclick="window.addReportC8()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold uppercase text-[9px] tracking-[0.2em] shadow-xl hover:bg-slate-800 transition-all active:scale-95">Simpan Laporan</button>
                        </div>
                    </div>
                    <div class="lg:col-span-8 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                        <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest">Log Laporan Tersimpan</h3>
                        <div class="space-y-3">
                            ${state.reportsC8.map(r => `
                                <div class="p-4 bg-slate-50 rounded-2xl flex justify-between items-center">
                                    <div class="uppercase">
                                        <div class="font-bold text-slate-700 text-xs">${r.date}</div>
                                        <div class="text-indigo-500 font-black text-[8px] tracking-widest leading-none mt-1">GURU: ${r.teacher}</div>
                                    </div>
                                    <button onclick="window.delReportC8('${r.id}')" class="p-2 text-rose-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- PEMANTAUAN (C7) ---
        function renderMonitoringC7() {
            return `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black uppercase tracking-tight">Pemantauan Pentadbir (C7)</h2>
                    <button onclick="window.preparePrint('C7')" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold text-[10px] uppercase flex items-center gap-2 shadow-xl hover:bg-indigo-700 transition-all">
                        <i data-lucide="printer" class="w-3.5 h-3.5"></i> Koleksi C7
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    <div class="lg:col-span-4 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                        <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest">Input Pemantauan</h3>
                        <div class="space-y-4">
                            <input id="c7Date" type="date" value="${new Date().toISOString().split('T')[0]}" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold text-xs">
                            <input id="c7Admin" type="text" placeholder="NAMA PENTADBIR" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl uppercase font-bold text-xs">
                            <textarea id="c7Notes" placeholder="ULASAN PEMANTAUAN" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl uppercase font-bold text-xs h-32 outline-none focus:border-emerald-500"></textarea>
                            <button onclick="window.addReportC7()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold uppercase text-[9px] tracking-[0.2em] shadow-xl hover:bg-slate-800 transition-all active:scale-95">Simpan C7</button>
                        </div>
                    </div>
                    <div class="lg:col-span-8 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                        <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest">Log Pemantauan</h3>
                        <div class="space-y-3">
                            ${state.reportsC7.map(r => `
                                <div class="p-4 bg-slate-50 rounded-2xl flex justify-between items-center">
                                    <div class="uppercase">
                                        <div class="font-bold text-slate-700 text-xs">${r.date}</div>
                                        <div class="text-emerald-500 font-black text-[8px] tracking-widest leading-none mt-1">OLEH: ${r.admin}</div>
                                    </div>
                                    <button onclick="window.delReportC7('${r.id}')" class="p-2 text-rose-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- DATABASE FUNCTIONS ---
        window.toggleAtt = async (id) => {
            const today = new Date().toISOString().split('T')[0];
            const records = state.attendance[today] || {};
            records[id] = !records[id];
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', today), { records, updatedAt: Date.now() });
        };

        window.addStudent = async () => {
            const n = document.getElementById('stuName').value;
            const c = document.getElementById('stuClass').value;
            if(!n || !c) return;
            const id = Date.now().toString();
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id), { id, name: n.toUpperCase(), className: c.toUpperCase() });
            document.getElementById('stuName').value = '';
        };

        window.delStudent = async (id) => { if(confirm('Padam murid ini?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id)); };

        window.addReportC8 = async () => {
            const date = document.getElementById('c8Date').value;
            const teacher = document.getElementById('c8Teacher').value;
            const notes = document.getElementById('c8Notes').value;
            if(!teacher) return;
            const id = Date.now().toString();
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reportsC8', id), { id, date, teacher: teacher.toUpperCase(), notes: notes.toUpperCase() });
            document.getElementById('c8Teacher').value = ''; document.getElementById('c8Notes').value = '';
        };

        window.delReportC8 = async (id) => { if(confirm('Padam laporan?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reportsC8', id)); };

        window.addReportC7 = async () => {
            const date = document.getElementById('c7Date').value;
            const admin = document.getElementById('c7Admin').value;
            const notes = document.getElementById('c7Notes').value;
            if(!admin) return;
            const id = Date.now().toString();
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reportsC7', id), { id, date, admin: admin.toUpperCase(), notes: notes.toUpperCase() });
            document.getElementById('c7Admin').value = ''; document.getElementById('c7Notes').value = '';
        };

        window.delReportC7 = async (id) => { if(confirm('Padam C7?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reportsC7', id)); };

        // --- PRINTING ENGINE ---
        window
