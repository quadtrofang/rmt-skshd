<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pengurusan RMT SKSHD - Cloud v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        @media print { 
            .no-print { display: none !important; } 
            .print-area { display: block !important; padding: 0 !important; margin: 0 !important; }
            table { border-collapse: collapse !important; width: 100% !important; }
            th, td { border: 1px solid black !important; padding: 4px !important; }
            @page { margin: 1cm; }
            .landscape { transform: rotate(0); } /* Handled by browser print settings */
        }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .nav-active { background-color: #059669; color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2); }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-800 text-xs h-screen flex flex-col overflow-hidden">

    <!-- OVERLAY LOADING -->
    <div id="loader" class="fixed inset-0 bg-slate-900 z-[9999] flex flex-col items-center justify-center text-white p-6 transition-all duration-500">
        <div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="loader-text" class="font-bold text-[9px] uppercase tracking-[0.3em] text-emerald-400">Menghubungkan Awan SKSHD...</p>
        <div id="diag-box" class="hidden mt-6 p-4 bg-rose-500/10 border border-rose-500/30 rounded-2xl max-w-sm w-full text-center">
            <p id="diag-msg" class="text-rose-300 text-[10px] font-medium"></p>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <!-- SIDEBAR -->
        <aside class="hidden md:flex flex-col w-64 bg-slate-900 text-white no-print">
            <div class="p-6 bg-slate-950 border-b border-slate-800 flex items-center gap-3">
                <div class="p-2 bg-emerald-500 rounded-xl"><i data-lucide="cloud" class="w-5 h-5"></i></div>
                <div>
                    <h1 class="font-black text-xs uppercase tracking-tighter leading-none">Sistem RMT</h1>
                    <p class="text-[7px] font-bold text-emerald-400 uppercase mt-1">SK Sg Haji Dorani</p>
                </div>
            </div>
            <nav class="flex-1 p-4 space-y-1">
                <button onclick="window.setTab('dash')" id="nav-dash" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all font-bold uppercase tracking-widest text-[9px] text-slate-400 hover:bg-slate-800">
                    <i data-lucide="check-square" class="w-4 h-4"></i> <span>Kehadiran (C9)</span>
                </button>
                <button onclick="window.setTab('stu')" id="nav-stu" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all font-bold uppercase tracking-widest text-[9px] text-slate-400 hover:bg-slate-800">
                    <i data-lucide="users" class="w-4 h-4"></i> <span>Urus Murid (C4)</span>
                </button>
                <button onclick="window.setTab('rep')" id="nav-rep" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all font-bold uppercase tracking-widest text-[9px] text-slate-400 hover:bg-slate-800">
                    <i data-lucide="clipboard-list" class="w-4 h-4"></i> <span>Laporan (C8)</span>
                </button>
                <button onclick="window.setTab('mon')" id="nav-mon" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all font-bold uppercase tracking-widest text-[9px] text-slate-400 hover:bg-slate-800">
                    <i data-lucide="shield-check" class="w-4 h-4"></i> <span>Pemantauan (C7)</span>
                </button>
            </nav>
            <div class="p-4 border-t border-slate-800 opacity-20 text-center">
                <p class="text-[7px] font-bold uppercase tracking-widest">Awan Berfungsi</p>
            </div>
        </aside>

        <!-- CONTENT AREA -->
        <div class="flex-1 flex flex-col overflow-hidden relative">
            <!-- Mobile Header -->
            <header class="md:hidden bg-slate-900 text-white p-3 flex justify-between items-center no-print shadow-xl">
                <div class="flex items-center gap-2">
                    <i data-lucide="cloud" class="w-4 h-4 text-emerald-400"></i>
                    <span class="font-black uppercase text-[10px]">RMT SKSHD</span>
                </div>
                <div class="flex gap-1">
                    <button onclick="window.setTab('dash')" class="p-2"><i data-lucide="check-square" class="w-4 h-4"></i></button>
                    <button onclick="window.setTab('stu')" class="p-2"><i data-lucide="users" class="w-4 h-4"></i></button>
                    <button onclick="window.setTab('rep')" class="p-2"><i data-lucide="clipboard-list" class="w-4 h-4"></i></button>
                    <button onclick="window.setTab('mon')" class="p-2"><i data-lucide="shield-check" class="w-4 h-4"></i></button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-4 md:p-8 custom-scroll">
                <div id="content" class="max-w-5xl mx-auto"></div>
            </main>

            <!-- PRINT OVERLAY -->
            <div id="print-overlay" class="fixed inset-0 bg-white z-[5000] hidden overflow-y-auto p-4 md:p-10 text-black">
                <div class="no-print mb-8 flex justify-between items-center sticky top-0 bg-white/95 backdrop-blur-md p-4 border-b">
                    <h3 class="font-black uppercase text-xs">Cetak Borang Rasmi</h3>
                    <div class="flex gap-2">
                        <button onclick="window.print()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold text-[9px] uppercase shadow-lg active:scale-95">Cetak</button>
                        <button onclick="document.getElementById('print-overlay').classList.add('hidden')" class="bg-slate-100 text-slate-500 px-6 py-2 rounded-lg font-bold text-[9px] uppercase">Tutup</button>
                    </div>
                </div>
                <div id="print-area" class="max-w-[210mm] mx-auto bg-white p-4"></div>
            </div>
        </div>
    </div>

    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // ============================================================
        // ⚠️ PASTE KUNCI FIREBASE ANDA DI SINI
        // ============================================================
        const firebaseConfig = {
  apiKey: "AIzaSyCdIiY2Bpu924jrZzaqVO0SqXvOYfPAjQc",
  authDomain: "rmt-skshd.firebaseapp.com",
  projectId: "rmt-skshd",
  storageBucket: "rmt-skshd.firebasestorage.app",
  messagingSenderId: "10103675688",
  appId: "1:10103675688:web:ddfec86ee46f4b2a148e1d",
  measurementId: "G-NQT5PZ1NDW"
};

        const showError = (m) => {
            const eb = document.getElementById('diag-box');
            eb.classList.remove('hidden');
            document.getElementById('diag-msg').innerText = m;
            document.getElementById('loader-text').innerText = "RALAT SAMBUNGAN";
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "skshd-rmt-cloud-final-v1";

        let state = {
            tab: 'dash',
            students: [],
            attendance: {},
            reportsC8: [],
            reportsC7: [],
            printMonth: new Date().toISOString().substring(0, 7)
        };

        window.setTab = (t) => { state.tab = t; render(); };

        function render() {
            const container = document.getElementById('content');
            document.querySelectorAll('aside nav button').forEach(b => b.classList.remove('nav-active'));
            const activeNav = document.getElementById(`nav-${state.tab}`);
            if (activeNav) activeNav.classList.add('nav-active');

            if (state.tab === 'dash') container.innerHTML = renderDashboard();
            else if (state.tab === 'stu') container.innerHTML = renderStudents();
            else if (state.tab === 'rep') container.innerHTML = renderReportsC8();
            else if (state.tab === 'mon') container.innerHTML = renderMonitoringC7();

            lucide.createIcons();
        }

        // --- RENDER KEHADIRAN (C9) ---
        function renderDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const att = state.attendance[today] || {};
            const hadir = Object.values(att).filter(v => v).length;

            return `
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8 no-print">
                    <div>
                        <h2 class="text-xl font-black uppercase tracking-tight">Rekod Kehadiran (C9)</h2>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">Tarikh: ${today}</p>
                    </div>
                    <div class="flex gap-2">
                         <input type="month" onchange="state.printMonth = this.value" value="${state.printMonth}" class="bg-white border p-2 rounded-xl text-[9px] font-bold uppercase outline-none">
                         <button onclick="window.preparePrint('C9_MONTH')" class="bg-emerald-600 text-white px-4 py-2 rounded-xl font-bold text-[9px] uppercase shadow-lg flex items-center gap-2">
                             <i data-lucide="calendar" class="w-3.5 h-3.5"></i> Cetak Bulanan
                         </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm">
                        <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Penerima Terdaftar</p>
                        <p class="text-3xl font-black text-slate-900">${state.students.length}</p>
                    </div>
                    <div class="bg-emerald-50 p-5 rounded-3xl border border-emerald-100 shadow-sm text-emerald-700">
                        <p class="text-[8px] font-black uppercase tracking-widest mb-1">Hadir Hari Ini</p>
                        <p class="text-3xl font-black">${hadir}</p>
                    </div>
                </div>

                <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-sm overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-100 text-[9px] font-bold uppercase text-slate-400">
                            <tr><th class="p-5 w-16 text-center">BIL</th><th class="p-5">PROFIL MURID</th><th class="p-5 text-center">TINDAKAN</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            ${state.students.map((s, i) => `
                                <tr class="hover:bg-slate-50/50">
                                    <td class="p-5 text-center font-bold text-slate-300">${i+1}</td>
                                    <td class="p-5 uppercase font-bold text-slate-700 leading-tight">
                                        ${s.name} <br><span class="text-[8px] font-black text-slate-400">${s.className}</span>
                                    </td>
                                    <td class="p-5 text-center">
                                        <button onclick="window.toggleAtt('${s.id}')" class="px-6 py-2 rounded-xl font-black text-[9px] uppercase transition-all shadow-md active:scale-90 ${att[s.id] ? 'bg-emerald-500 text-white border-b-4 border-emerald-700' : 'bg-slate-100 text-slate-400 border-b-4 border-slate-300'}">
                                            ${att[s.id] ? 'Makan' : 'Tidak'}
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // --- RENDER URUS MURID (C4) ---
        function renderStudents() {
            return `
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-xl font-black uppercase tracking-tight">Pengurusan Murid</h2>
                    <button onclick="window.preparePrint('C4')" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl font-bold text-[9px] uppercase shadow-lg flex items-center gap-2">
                        <i data-lucide="printer" class="w-3.5 h-3.5"></i> Cetak C4
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-4 space-y-6">
                        <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
                            <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest">Daftar Tunggal</h3>
                            <div class="space-y-4">
                                <input id="stuName" type="text" placeholder="NAMA PENUH" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl uppercase font-bold text-xs outline-none focus:border-emerald-500 transition-all">
                                <input id="stuClass" type="text" placeholder="KELAS" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl uppercase font-bold text-xs outline-none focus:border-emerald-500 transition-all">
                                <button onclick="window.addStudent()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold uppercase text-[9px] tracking-widest">Simpan Murid</button>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
                            <h3 class="font-black uppercase text-[10px] text-slate-400 mb-4 tracking-widest">Daftar Pukal (Bulk)</h3>
                            <p class="text-[8px] font-bold text-slate-400 uppercase mb-3 leading-relaxed italic">Masukkan nama & kelas dibatasi dengan tanda koma.<br>Contoh: AHMAD ALI, 1 AMANAH</p>
                            <textarea id="bulkData" placeholder="ALI BIN ABU, 1A\nSITI AMINAH, 2B" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl uppercase font-bold text-[10px] h-32 outline-none focus:border-emerald-500 transition-all"></textarea>
                            <button onclick="window.addBulk()" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold uppercase text-[9px] tracking-widest mt-3">Upload Pukal</button>
                        </div>
                    </div>

                    <div class="lg:col-span-8 bg-white p-6 rounded-[2.5rem] border border-slate-200 shadow-sm overflow-hidden">
                        <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest px-4">Senarai Penerima RMT (${state.students.length})</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 px-4 pb-4">
                            ${state.students.map(s => `
                                <div class="p-4 bg-slate-50 rounded-2xl flex justify-between items-center group transition-all hover:bg-white hover:shadow-lg border border-transparent hover:border-slate-100">
                                    <div class="uppercase">
                                        <div class="font-bold text-slate-700 text-xs leading-none">${s.name}</div>
                                        <div class="text-emerald-500 font-black text-[8px] tracking-widest mt-1">${s.className}</div>
                                    </div>
                                    <button onclick="window.delStudent('${s.id}')" class="p-2 text-slate-300 hover:text-rose-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- RENDER LAPORAN HARIAN (C8) ---
        function renderReportsC8() {
            return `
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-xl font-black uppercase tracking-tight">Laporan Harian RMT (C8)</h2>
                    <button onclick="window.preparePrint('C8')" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold text-[9px] uppercase shadow-lg flex items-center gap-2">
                        <i data-lucide="printer" class="w-3.5 h-3.5"></i> Cetak C8
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-4 bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
                        <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest">Input Laporan Lengkap</h3>
                        <div class="space-y-4">
                            <input id="c8Date" type="date" value="${new Date().toISOString().split('T')[0]}" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold text-xs outline-none">
                            <input id="c8Teacher" type="text" placeholder="GURU BERTUGAS" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl uppercase font-bold text-xs outline-none">
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-[8px] font-black text-slate-400 uppercase tracking-widest ml-1">Menu (1-4)</label>
                                <input id="c8ScoreMenu" type="number" min="1" max="4" value="4" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl font-bold text-xs outline-none"></div>
                                <div><label class="text-[8px] font-black text-slate-400 uppercase tracking-widest ml-1">Rasa (1-4)</label>
                                <input id="c8ScoreTaste" type="number" min="1" max="4" value="4" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl font-bold text-xs outline-none"></div>
                                <div><label class="text-[8px] font-black text-slate-400 uppercase tracking-widest ml-1">Bersih (1-4)</label>
                                <input id="c8ScoreClean" type="number" min="1" max="4" value="4" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl font-bold text-xs outline-none"></div>
                                <div><label class="text-[8px] font-black text-slate-400 uppercase tracking-widest ml-1">Adab (1-4)</label>
                                <input id="c8ScoreAdab" type="number" min="1" max="4" value="4" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl font-bold text-xs outline-none"></div>
                            </div>

                            <textarea id="c8Notes" placeholder="CATATAN / ULASAN LAIN" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl uppercase font-bold text-xs h-24 outline-none focus:border-indigo-500 transition-all"></textarea>
                            <button onclick="window.addReportC8()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold uppercase text-[9px] tracking-widest shadow-xl">Simpan C8</button>
                        </div>
                    </div>
                    <div class="lg:col-span-8 bg-white p-6 rounded-[2.5rem] border border-slate-200 shadow-sm">
                        <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest px-4">Log Rekod Tersimpan</h3>
                        <div class="space-y-3 px-2">
                            ${state.reportsC8.map(r => `
                                <div class="p-4 bg-slate-50 rounded-2xl flex justify-between items-center hover:bg-white hover:shadow-md transition-all">
                                    <div class="uppercase">
                                        <div class="font-bold text-slate-700 text-xs">${r.date}</div>
                                        <div class="text-indigo-500 font-black text-[8px] tracking-widest leading-none mt-1">OLEH: ${r.teacher}</div>
                                    </div>
                                    <button onclick="window.delReportC8('${r.id}')" class="p-2 text-rose-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- RENDER PEMANTAUAN (C7) ---
        function renderMonitoringC7() {
            return `
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-xl font-black uppercase tracking-tight">Pemantauan Pentadbir (C7)</h2>
                    <button onclick="window.preparePrint('C7')" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold text-[10px] uppercase shadow-lg flex items-center gap-2">
                        <i data-lucide="printer" class="w-3.5 h-3.5"></i> Koleksi C7
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-4 bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
                        <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest">Input Pemantauan</h3>
                        <div class="space-y-4">
                            <input id="c7Date" type="date" value="${new Date().toISOString().split('T')[0]}" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold text-xs outline-none">
                            <input id="c7Admin" type="text" placeholder="NAMA PENTADBIR" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl uppercase font-bold text-xs outline-none">
                            <textarea id="c7Notes" placeholder="ULASAN & CADANGAN PENAMBAHBAIKAN" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl uppercase font-bold text-xs h-32 outline-none focus:border-indigo-500"></textarea>
                            <button onclick="window.addReportC7()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold uppercase text-[9px] tracking-widest shadow-xl">Simpan C7</button>
                        </div>
                    </div>
                    <div class="lg:col-span-8 bg-white p-6 rounded-[2.5rem] border border-slate-200 shadow-sm">
                        <h3 class="font-black uppercase text-[10px] text-slate-400 mb-6 tracking-widest px-4">Rekod Pemantauan</h3>
                        <div class="space-y-3 px-2">
                            ${state.reportsC7.map(r => `
                                <div class="p-4 bg-slate-50 rounded-2xl flex justify-between items-center">
                                    <div class="uppercase">
                                        <div class="font-bold text-slate-700 text-xs">${r.date}</div>
                                        <div class="text-emerald-500 font-black text-[8px] tracking-widest leading-none mt-1">PEMANTAU: ${r.admin}</div>
                                    </div>
                                    <button onclick="window.delReportC7('${r.id}')" class="p-2 text-rose-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- DATA SYNC LOGIC ---
        window.toggleAtt = async (id) => {
            const today = new Date().toISOString().split('T')[0];
            const records = state.attendance[today] || {};
            records[id] = !records[id];
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', today), { records, updatedAt: Date.now() });
        };

        window.addStudent = async () => {
            const n = document.getElementById('stuName').value;
            const c = document.getElementById('stuClass').value;
            if(!n || !c) return;
            const id = Date.now().toString();
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id), { id, name: n.toUpperCase(), className: c.toUpperCase() });
            document.getElementById('stuName').value = '';
            document.getElementById('stuClass').value = '';
        };

        window.addBulk = async () => {
            const text = document.getElementById('bulkData').value;
            if(!text) return;
            const lines = text.split('\n');
            for(let line of lines) {
                const parts = line.split(',');
                if(parts.length >= 2) {
                    const id = Date.now().toString() + Math.random();
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id), { id, name: parts[0].trim().toUpperCase(), className: parts[1].trim().toUpperCase() });
                }
            }
            document.getElementById('bulkData').value = '';
            alert('Upload pukal berjaya!');
        };

        window.delStudent = async (id) => { if(confirm('Padam data murid?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id)); };

        window.addReportC8 = async () => {
            const dStr = document.getElementById('c8Date').value;
            const teacher = document.getElementById('c8Teacher').value;
            const menu = document.getElementById('c8ScoreMenu').value;
            const taste = document.getElementById('c8ScoreTaste').value;
            const clean = document.getElementById('c8ScoreClean').value;
            const adab = document.getElementById('c8ScoreAdab').value;
            const notes = document.getElementById('c8Notes').value;
            if(!teacher) return;
            const id = Date.now().toString();
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reportsC8', id), { 
                id, date: dStr, teacher: teacher.toUpperCase(), 
                menu, taste, clean, adab, notes: notes.toUpperCase() 
            });
            document.getElementById('c8Teacher').value = ''; document.getElementById('c8Notes').value = '';
        };

        window.delReportC8 = async (id) => { if(confirm('Padam laporan?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reportsC8', id)); };

        window.addReportC7 = async () => {
            const dStr = document.getElementById('c7Date').value;
            const admin = document.getElementById('c7Admin').value;
            const notes = document.getElementById('c7Notes').value;
            if(!admin) return;
            const id = Date.now().toString();
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reportsC7', id), { id, date: dStr, admin: admin.toUpperCase(), notes: notes.toUpperCase() });
            document.getElementById('c7Admin').value = ''; document.getElementById('c7Notes').value = '';
        };

        window.delReportC7 = async (id) => { if(confirm('Padam?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reportsC7', id)); };

        // --- PRINTING LOGIC ---
        window.preparePrint = (mode) => {
            const overlay = document.getElementById('print-overlay');
            const area = document.getElementById('print-area');
            overlay.classList.remove('hidden');

            if (mode === 'C9_MONTH') {
                const [y, m] = state.printMonth.split('-').map(Number);
                const monthName = new Date(y, m-1).toLocaleString('ms-MY', { month: 'long', year: 'numeric' });
                const daysInMonth = new Date(y, m, 0).getDate();
                
                area.innerHTML = `
                    <div class="text-center mb-8 border-b-2 border-black pb-4">
                        <h1 class="text-xl font-black underline uppercase leading-tight">REKOD KEHADIRAN RMT (C9) - BULANAN</h1>
                        <p class="font-bold mt-2 uppercase">BULAN: ${monthName}</p>
                        <p class="font-bold uppercase tracking-widest text-xs">SK SUNGAI HAJI DORANI</p>
                    </div>
                    <table class="w-full border-collapse border border-black text-[6px] text-center uppercase">
                        <thead><tr class="bg-gray-100 font-bold">
                            <th class="border border-black p-1 w-4">BIL</th>
                            <th class="border border-black p-1 text-left px-2 w-32">NAMA MURID</th>
                            <th class="border border-black p-1 w-8">KELAS</th>
                            ${[...Array(daysInMonth)].map((_, i) => `<th class="border border-black w-2">${i+1}</th>`).join('')}
                            <th class="border border-black p-1 w-8">JUMLAH</th>
                        </tr></thead>
                        <tbody>${state.students.map((s, i) => {
                            let total = 0;
                            return `<tr>
                                <td class="border border-black p-1">${i+1}</td>
                                <td class="border border-black p-1 text-left px-2 truncate">${s.name}</td>
                                <td class="border border-black p-1">${s.className}</td>
                                ${[...Array(daysInMonth)].map((_, di) => {
                                    const dateKey = `${y}-${String(m).padStart(2,'0')}-${String(di+1).padStart(2,'0')}`;
                                    const dayType = new Date(dateKey).getDay();
                                    const isWeekend = dayType === 0 || dayType === 6;
                                    const status = (state.attendance[dateKey] || {})[s.id];
                                    if (isWeekend) return `<td class="border border-black bg-gray-100 text-[4px]">C</td>`;
                                    if (status === true) { total++; return `<td class="border border-black">/</td>`; }
                                    if (status === false) return `<td class="border border-black text-red-500 font-bold">O</td>`;
                                    return `<td class="border border-black"></td>`;
                                }).join('')}
                                <td class="border border-black font-bold">${total}</td>
                            </tr>`
                        }).join('')}</tbody>
                    </table>
                `;
            } else if (mode === 'C4') {
                area.innerHTML = `
                    <div class="text-center mb-10">
                        <h1 class="text-2xl font-black underline uppercase">SENARAI PENERIMA RMT (BORANG C4)</h1>
                        <p class="font-bold mt-2 underline uppercase">SESI 2025/2026 - SK SUNGAI HAJI DORANI</p>
                    </div>
                    <table class="w-full border-collapse border-2 border-black text-sm uppercase">
                        <thead><tr class="bg-gray-100 border-2 border-black font-bold">
                            <th class="border-2 border-black p-3 w-16">BIL</th><th class="border-2 border-black p-3 text-left px-6">NAMA MURID</th><th class="border-2 border-black p-3 w-40">TAHUN / KELAS</th>
                        </tr></thead>
                        <tbody>${state.students.map((s, i) => `
                            <tr><td class="border border-black p-3 text-center">${i+1}</td><td class="border border-black p-3 px-6">${s.name}</td><td class="border border-black p-3 text-center">${s.className}</td></tr>
                        `).join('')}</tbody>
                    </table>
                `;
            } else if (mode === 'C8') {
                area.innerHTML = `
                    <h1 class="text-center text-xl font-black underline mb-10 uppercase">LOG LAPORAN HARIAN GURU (BORANG C8)</h1>
                    <table class="w-full border-collapse border border-black text-[10px] uppercase">
                        <thead class="bg-gray-50"><tr><th class="border border-black p-2">TARIKH</th><th class="border border-black p-2">GURU</th><th class="border border-black p-2">MENU/RASA/BERSIH/ADAB</th><th class="border border-black p-2">ULASAN</th></tr></thead>
                        <tbody>${state.reportsC8.map(r => `
                            <tr><td class="border border-black p-2 w-24 text-center">${r.date}</td><td class="border border-black p-2 w-32">${r.teacher}</td><td class="border border-black p-2 text-center">${r.menu}/${r.taste}/${r.clean}/${r.adab}</td><td class="border border-black p-2 italic">${r.notes}</td></tr>
                        `).join('')}</tbody>
                    </table>
                `;
            } else if (mode === 'C7') {
                area.innerHTML = `
                    <h1 class="text-center text-xl font-black underline mb-10 uppercase font-serif">LAPORAN PEMANTAUAN PENTADBIR (BORANG C7)</h1>
                    ${state.reportsC7.map(r => `
                        <div class="mb-12 border-4 border-black p-10 uppercase text-[11px] min-h-[150mm] relative">
                            <div class="flex justify-between font-black text-sm mb-10 border-b-2 border-black pb-2">
                                <span>TARIKH LAWATAN: ${r.date}</span>
                                <span>PEMANTAU: ${r.admin}</span>
                            </div>
                            <div class="font-bold">ULASAN DAN CADANGAN PENAMBAHBAIKAN:</div>
                            <div class="mt-4 p-6 border border-black italic bg-slate-50 min-h-[100px]">${r.notes}</div>
                        </div>
                    `).join('')}
                `;
            }
        };

        // --- AUTH & DATA START ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) { await signInAnonymously(auth); return; }
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'students'), (snap) => {
                state.students = snap.docs.map(d => d.data()).sort((a,b) => a.name.localeCompare(b.name));
                document.getElementById('loader').classList.add('opacity-0', 'pointer-events-none');
                render();
            }, (e) => showError("Pangkalan data ditutup. Sila periksa tab Rules di Firestore."));
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), (snap) => {
                snap.docs.forEach(d => state.attendance[d.id] = d.data().records);
                render();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'reportsC8'), (snap) => {
                state.reportsC8 = snap.docs.map(d => d.data()).sort((a,b) => b.date.localeCompare(a.date));
                render();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'reportsC7'), (snap) => {
                state.reportsC7 = snap.docs.map(d => d.data()).sort((a,b) => b.date.localeCompare(a.date));
                render();
            });
        });
    </script>
</body>
</html>
